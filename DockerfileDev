# https://www.baeldung.com/ops/docker-cache-maven-dependencies
FROM maven:3.8.5-openjdk-17 as builder

# Sett opp home directory
ENV HOME=/usr/app
RUN mkdir -p $HOME
WORKDIR $HOME

# Kopier alle pom.xml
COPY pom.xml $HOME

COPY api/pom.xml $HOME/api/pom.xml
COPY soknadsfillager-api/pom.xml $HOME/soknadsfillager-api/pom.xml
COPY soknadsmottaker-api/pom.xml $HOME/soknadsmottaker-api/pom.xml
COPY innsender/pom.xml $HOME/innsender/pom.xml

# Rekkefølgen her burde være fra minst til mest endring siden hvert layer blir cachet
RUN mvn -pl api verify --fail-never -DskipTests
COPY api $HOME/api
RUN mvn -pl api install

RUN mvn -pl soknadsfillager-api verify --fail-never -DskipTests
COPY soknadsfillager-api $HOME/soknadsfillager-api
RUN mvn -pl soknadsfillager-api install

RUN mvn -pl soknadsmottaker-api verify --fail-never -DskipTests
COPY soknadsmottaker-api $HOME/soknadsmottaker-api
RUN mvn -pl soknadsmottaker-api install

RUN mvn -pl innsender-api verify --fail-never -DskipTests
COPY innsender $HOME/innsender

# Kompiler og pakk inn i en jar
RUN --mount=type=cache,target=/root/.m2,rw mvn -q -pl api,soknadsfillager-api,soknadsmottaker-api,innsender package -DskipTests


FROM openjdk:17-alpine
EXPOSE 9064

# Kjør jar-filen
COPY --from=builder /usr/app/innsender/target/innsender.jar /app/innsender.jar
ENTRYPOINT java -jar /app/innsender.jar
